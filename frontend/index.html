<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wildfire Detection & Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
      100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }
    .sidebar {
      background-color: #fff;
      height: 100vh;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      padding: 20px;
      overflow-y: auto;
    }
    .main-content {
      padding: 20px;
      height: 100vh;
      overflow-y: auto;
    }
    #map {
      height: 400px;
      width: 100%;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .analysis-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .risk-low { color: #28a745; }
    .risk-medium { color: #ffc107; }
    .risk-high { color: #fd7e14; }
    .risk-extreme { color: #dc3545; }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .spinner-border {
      width: 3rem; 
      height: 3rem;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-4 col-lg-3 sidebar">
        <div class="text-center mb-4">
          <h2 class="text-primary">Wildfire Detection</h2>
          <p class="text-muted">Real-time wildfire analysis using satellite data</p>
        </div>
        
        <div class="mb-4">
          <h5>Location Search</h5>
          <div class="input-group mb-3">
            <input type="text" id="location-search" class="form-control" placeholder="Enter location or coordinates">
            <button class="btn btn-outline-secondary" type="button" id="voice-search-btn" title="Search by voice">
              <i class="bi bi-mic"></i>
            </button>
            <button class="btn btn-primary" type="button" id="search-btn">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
          <div id="voice-status" class="small text-muted mb-2" style="display: none;">
            <i class="bi bi-mic-fill text-danger"></i> Listening...
          </div>
          
          <div id="map"></div>
          
          <form id="analysis-form" class="mt-3">
            <div class="mb-3">
              <label for="date-range" class="form-label">Date Range</label>
              <select class="form-select" id="date-range">
                <option value="1">Last 24 hours</option>
                <option value="3">Last 3 days</option>
                <option value="7" selected>Last 7 days</option>
                <option value="30">Last 30 days</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="radius" class="form-label">Search Radius: <span id="radius-value">50</span> km</label>
              <input type="range" class="form-range" min="1" max="100" value="50" id="radius">
            </div>
            
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" role="switch" id="generate-image" checked>
              <label class="form-check-label" for="generate-image">Generate Visualization</label>
              <small class="form-text text-muted d-block">Enable AI-generated visualization (may take longer to process)</small>
            </div>
            
            <button type="submit" class="btn btn-primary w-100">
              <span id="analyze-text">Analyze Location</span>
              <span id="analyze-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </form>
        </div>
        
        <div class="mt-4">
          <h5>Recent Analyses</h5>
          <div id="recent-analyses" class="list-group">
            <!-- Recent analyses will be added here -->
          </div>
        </div>
        
        <div class="analysis-card">
          <h4>Visualization</h4>
          <div id="visualization-container" class="mt-3 text-center">
            <p class="text-muted">A visualization will appear here if image generation is enabled.</p>
          </div>
        </div>
        
        <div class="analysis-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">Detailed Analysis</h4>
            <button id="read-aloud-btn" class="btn btn-sm btn-outline-secondary" title="Read aloud">
              <i class="bi bi-volume-up"></i>
            </button>
          </div>
          <div id="detailed-analysis" class="mt-3">
            <p class="text-muted">Detailed analysis will appear here after running an analysis.</p>
          </div>
        </div>
      </div>
      
      <!-- Main Content -->
      <div class="col-md-8 col-lg-9 main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Wildfire Analysis</h2>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="export-dropdown" data-bs-toggle="dropdown">
              <i class="bi bi-download"></i> Export
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" id="export-pdf">PDF Report</a></li>
              <li><a class="dropdown-item" href="#" id="export-csv">CSV Data</a></li>
            </ul>
          </div>
        </div>
        
        <div id="loading" class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Analyzing location data...</p>
        </div>
        
        <div id="analysis-results">
          <div class="alert alert-info">
            <h4 class="alert-heading">Welcome to Wildfire Detection</h4>
            <p>To get started, search for a location and click "Analyze Location" to perform a wildfire risk assessment.</p>
            <hr>
            <p class="mb-0">You can also click anywhere on the map to select a specific location.</p>
          </div>
          
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="analysis-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0"><i class="bi bi-fire"></i> Fire Detection</h5>
                  <span id="fire-confidence-badge" class="badge bg-secondary">Analyzing...</span>
                </div>
                <div id="fire-detection">
                  <div class="progress mb-3" style="height: 10px;">
                    <div id="fire-confidence-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
                  </div>
                  <div id="fire-detection-details">
                    <p class="text-muted mb-1">Scanning satellite data for thermal anomalies...</p>
                    <small class="text-muted">Last updated: <span id="fire-last-updated">-</span></small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="analysis-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0"><i class="bi bi-shield-exclamation"></i> Risk Assessment</h5>
                  <span id="risk-level-badge" class="badge bg-secondary">Evaluating...</span>
                </div>
                <div id="risk-assessment">
                  <div class="alert alert-light mb-3" id="risk-level-container">
                    <div class="d-flex justify-content-between align-items-center">
                      <span>Risk Level:</span>
                      <span id="risk-level-text" class="fw-bold">-</span>
                    </div>
                    <div class="progress mt-2" style="height: 8px;">
                      <div id="risk-level-bar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                    </div>
                  </div>
                  <div id="risk-factors">
                    <p class="text-muted mb-1">Assessing environmental conditions...</p>
                    <small class="text-muted">Last updated: <span id="risk-last-updated">-</span></small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="analysis-card mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0"><i class="bi bi-map"></i> Detailed Analysis</h5>
              <span class="badge bg-primary">Analysis</span>
            </div>
            <div id="detailed-analysis" class="analysis-content">
              <div class="alert alert-light">
                <div class="d-flex align-items-center">
                  <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                  <span>Analyzing location data. This may take a moment...</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="analysis-card mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Recommendations</h5>
              <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" 
                 data-bs-placement="top" 
                 title="Recommendations are based on current fire detection and risk assessment"></i>
            </div>
            <div id="recommendations" class="analysis-content">
              <div class="alert alert-light">
                <p class="mb-0">Recommendations will be generated after the analysis is complete.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Error</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="error-message">
          An error occurred while processing your request.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script>
    // Voice recognition and synthesis
    let recognition;
    let synthesis = window.speechSynthesis;
    let isListening = false;
    
    // Initialize map
    let map;
    let marker;
    let currentLat = 37.7749;
    let currentLng = -122.4194;
    
    function initMap() {
      map = L.map('map').setView([currentLat, currentLng], 10);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Add click event to update location
      map.on('click', function(e) {
        currentLat = e.latlng.lat;
        currentLng = e.latlng.lng;
        updateMapMarker();
        updateLocationSearch();
      });
      
      // Initialize marker
      updateMapMarker();
      
      // Initialize geocoder
      const geocoder = L.Control.Geocoder.nominatim();
      
      // Setup search functionality
      document.getElementById('search-btn').addEventListener('click', function() {
        const query = document.getElementById('location-search').value;
        if (!query) return;
        
        geocoder.geocode(query, function(results) {
          if (results && results.length > 0) {
            const result = results[0];
            currentLat = result.center.lat;
            currentLng = result.center.lng;
            map.setView([currentLat, currentLng], 12);
            updateMapMarker();
          }
        });
      });
      
      // Handle form submission
      document.getElementById('analysis-form').addEventListener('submit', function(e) {
        e.preventDefault();
        analyzeLocation();
      });
      
      // Update radius value display
      const radiusSlider = document.getElementById('radius');
      const radiusValue = document.getElementById('radius-value');
      radiusSlider.addEventListener('input', function() {
        radiusValue.textContent = this.value;
      });
    }
    
    function updateMapMarker() {
      if (marker) {
        map.removeLayer(marker);
      }
      marker = L.marker([currentLat, currentLng]).addTo(map);
    }
    
    function updateLocationSearch() {
      // Reverse geocode to update search box
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLat}&lon=${currentLng}&zoom=10`)
        .then(response => response.json())
        .then(data => {
          const displayName = data.display_name ? data.display_name.split(',').slice(0, 3).join(',') : `${currentLat.toFixed(4)}, ${currentLng.toFixed(4)}`;
          document.getElementById('location-search').value = displayName;
        });
    }
    
    async function analyzeLocation() {
      const dateRange = document.getElementById('date-range').value;
      const radius = document.getElementById('radius').value;
      const generateImage = document.getElementById('generate-image').checked;
      
      // Show loading state
      document.getElementById('loading').style.display = 'block';
      document.getElementById('analyze-text').classList.add('d-none');
      document.getElementById('analyze-spinner').classList.remove('d-none');
      
      try {
        const response = await fetch('http://localhost:8000/api/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            coordinates: {
              lat: currentLat,
              lon: currentLng
            },
            date_range: `${dateRange}d`,
            radius_km: parseInt(radius),
            generate_image: generateImage
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to analyze location');
        }
        
        const data = await response.json();
        displayAnalysisResults(data);
        addToRecentAnalyses(data);
      } catch (error) {
        console.error('Error:', error);
        showError('Failed to analyze location. Please try again.');
      } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('analyze-text').classList.remove('d-none');
        document.getElementById('analyze-spinner').classList.add('d-none');
      }
    }
    
    // Simple markdown to HTML converter
    function markdownToHtml(text) {
      if (!text || typeof text !== 'string') return '';
      
      // Clean up the text first
      text = text
        .replace(/headers: \{.*?\}, body: JSON\.stringify\(\{text\}\) \}\);.*/s, '') // Remove debug info
        .replace(/\*\*\s*\*\*/g, '') // Remove empty bold markers
        .trim();
      if (!text) return '';
      
      // Convert markdown to HTML
      return text
        // Headers
        .replace(/^### (.*$)/gm, '<h5>$1</h5>')
        .replace(/^## (.*$)/gm, '<h4>$1</h4>')
        .replace(/^# (.*$)/gm, '<h3>$1</h3>')
        // Bold and italic
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Lists
        .replace(/^\s*[-*] (.*$)/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
        // Line breaks
        .replace(/\n\n/g, '</p><p>')
        // Fix any nested lists
        .replace(/<\/ul>\s*<ul>/g, '')
        // Wrap in paragraph if needed
        .replace(/^(?!<[a-z])(.*)$/gm, '<p>$1</p>')
        // Clean up any empty paragraphs
        .replace(/<p>\s*<\/p>/g, '');
    }
    
    function extractSection(text, sectionTitle, defaultText = '') {
      if (!text) return defaultText;
      
      // Try with **Section:** pattern first
      let regex = new RegExp(`\\*\\*${sectionTitle}:?\\*\\*([\\s\\S]*?)(?=\\*\\*[A-Z]|$)`);
      let match = text.match(regex);
      
      // If not found, try with ## Section pattern
      if (!match) {
        regex = new RegExp(`##\\s*${sectionTitle}[\\s\\n]+([\\s\\S]*?)(?=##|$)`);
        match = text.match(regex);
      }
      
      // If still not found, try to find any relevant information
      if (!match) {
        const lowerText = text.toLowerCase();
        const lowerSection = sectionTitle.toLowerCase();
        
        if (lowerSection.includes('fire') && lowerText.includes('fire')) {
          // For fire detection, look for confidence levels
          const confidenceMatch = text.match(/(confidence|detection).*?(low|medium|high|\d+%)/i);
          if (confidenceMatch) return `Fire detection confidence: ${confidenceMatch[2] || 'unknown'}`;
        }
        
        if (lowerSection.includes('risk') && lowerText.includes('risk')) {
          // For risk assessment, look for risk levels
          const riskMatch = text.match(/risk.*?(low|moderate|medium|high|extreme)/i);
          if (riskMatch) return `Risk level: ${riskMatch[1] || 'unknown'}`;
        }
        
        return defaultText || `No ${sectionTitle.toLowerCase()} information available.`;
      }
      
      return match[1].trim();
    }
    
    function updateRiskLevel(level) {
      const riskLevels = {
        'low': { class: 'bg-success', width: '25%' },
        'moderate': { class: 'bg-info', width: '50%' },
        'medium': { class: 'bg-warning', width: '50%' },
        'high': { class: 'bg-danger', width: '75%' },
        'extreme': { class: 'bg-dark', width: '100%' },
        'default': { class: 'bg-secondary', width: '0%' }
      };
      
      const riskInfo = riskLevels[level.toLowerCase()] || riskLevels.default;
      const badgeClass = riskInfo.class.replace('bg-', 'bg-');
      
      document.getElementById('risk-level-badge').className = `badge ${badgeClass}`;
      document.getElementById('risk-level-badge').textContent = level.charAt(0).toUpperCase() + level.slice(1);
      document.getElementById('risk-level-text').textContent = level.charAt(0).toUpperCase() + level.slice(1);
      document.getElementById('risk-level-bar').className = `progress-bar ${riskInfo.class}`;
      document.getElementById('risk-level-bar').style.width = riskInfo.width;
    }
    
    function updateFireConfidence(confidence) {
      let width = '0%';
      let badgeClass = 'bg-secondary';
      
      if (confidence) {
        const percentMatch = confidence.match(/(\d+)%/);
        if (percentMatch) {
          width = percentMatch[0];
        } else if (confidence.toLowerCase().includes('high')) {
          width = '80%';
          badgeClass = 'bg-danger';
        } else if (confidence.toLowerCase().includes('medium')) {
          width = '50%';
          badgeClass = 'bg-warning';
        } else if (confidence.toLowerCase().includes('low')) {
          width = '20%';
          badgeClass = 'bg-success';
        }
      }
      
      document.getElementById('fire-confidence-bar').style.width = width;
      document.getElementById('fire-confidence-bar').className = `progress-bar progress-bar-striped progress-bar-animated ${badgeClass}`;
      document.getElementById('fire-confidence-badge').className = `badge ${badgeClass}`;
      document.getElementById('fire-confidence-badge').textContent = confidence || 'Unknown';
    }
    
    function displayAnalysisResults(data) {
      // Clean up the response data
      let analysisText = '';
      let imageId = null;
      
      if (typeof data === 'string') {
        // Handle case where data is a string
        analysisText = data;
      } else if (data && typeof data === 'object') {
        // Handle case where data is an object
        if (data.analysis) {
          analysisText = data.analysis;
        } else if (data.generated) {
          analysisText = data.generated;
        } else {
          // If no specific analysis field, try to stringify the response
          try {
            analysisText = JSON.stringify(data, null, 2);
          } catch (e) {
            analysisText = 'Received analysis data in an unexpected format.';
          }
        }
        
        // Check for image ID in the response
        if (data.image_id) {
          imageId = data.image_id;
        }
      } else {
        analysisText = 'No analysis data available.';
      }
      
      const timestamp = new Date().toLocaleString();
      
      // Extract sections from the analysis with better defaults
      const fireDetection = extractSection(analysisText, 'Fire Detection', 
        'No active fires detected in the selected area.');
        
      const riskAssessment = extractSection(analysisText, 'Risk Assessment', 
        'Standard risk assessment in progress...');
        
      const recommendations = extractSection(analysisText, 'Recommendations',
        extractSection(analysisText, 'Recommended Actions',
        'Recommendations will be provided based on the analysis.'));
      
      // Update timestamps
      document.getElementById('fire-last-updated').textContent = timestamp;
      document.getElementById('risk-last-updated').textContent = timestamp;
      
      // Update fire detection
      updateFireConfidence(fireDetection);
      
      // Update risk assessment
      const riskLevel = riskAssessment.toLowerCase().match(/(low|moderate|medium|high|extreme)/);
      if (riskLevel) {
        updateRiskLevel(riskLevel[0]);
      } else {
        updateRiskLevel('evaluating');
      }
      
      // Update the UI with formatted content
      const formatContent = (content) => {
        if (!content || content.trim() === '') return '<p class="text-muted">No information available.</p>';
        const formatted = markdownToHtml(content);
        return formatted || '<p class="text-muted">No information available.</p>';
      };
      
      // Update each section with proper error handling
      try {
        document.getElementById('fire-detection').innerHTML = formatContent(fireDetection);
      } catch (e) {
        console.error('Error updating fire detection:', e);
        document.getElementById('fire-detection').innerHTML = '<p class="text-muted">Error loading fire detection data.</p>';
      }
      
      try {
        document.getElementById('risk-assessment').innerHTML = formatContent(riskAssessment);
      } catch (e) {
        console.error('Error updating risk assessment:', e);
        document.getElementById('risk-assessment').innerHTML = '<p class="text-muted">Error loading risk assessment.</p>';
      }
      
      try {
        document.getElementById('recommendations').innerHTML = formatContent(recommendations);
      } catch (e) {
        console.error('Error updating recommendations:', e);
        document.getElementById('recommendations').innerHTML = '<p class="text-muted">Error loading recommendations.</p>';
      }
      
      try {
        const detailedAnalysis = document.getElementById('detailed-analysis');
        detailedAnalysis.innerHTML = formatContent(analysisText);
        
        // Add some basic styling to the analysis content
        const analysisContent = detailedAnalysis.querySelectorAll('p, li, h1, h2, h3, h4, h5, h6');
        analysisContent.forEach(el => {
          el.classList.add('mb-2');
        });
      } catch (e) {
        console.error('Error updating detailed analysis:', e);
        document.getElementById('detailed-analysis').innerHTML = '<p class="text-muted">Error loading detailed analysis.</p>';
      }
      
      // Handle image display if available
      const visualizationContainer = document.getElementById('visualization-container');
      if (imageId) {
        const imageUrl = `/api/image/${imageId}?t=${Date.now()}`; // Add timestamp to prevent caching
        visualizationContainer.innerHTML = `
          <div class="text-center">
            <h4 class="mb-3">Wildfire Visualization</h4>
            <div class="spinner-border text-primary mb-3" role="status" id="image-loading">
              <span class="visually-hidden">Loading visualization...</span>
            </div>
            <img src="${imageUrl}" 
                 class="img-fluid rounded shadow" 
                 id="generated-image" 
                 style="display: none; max-height: 500px; width: 100%; object-fit: contain;"
                 onload="document.getElementById('image-loading').style.display = 'none'; this.style.display = 'block'"
                 onerror="document.getElementById('image-loading').style.display = 'none'; this.style.display = 'none'; document.getElementById('visualization-container').innerHTML = '<p class=\'text-muted\'>Failed to load visualization. The image may still be generating.</p>'"
                 alt="Wildfire visualization">
          </div>
        `;
      } else {
        visualizationContainer.innerHTML = '<p class="text-muted">No visualization available. Enable image generation in the analysis settings.</p>';
      }
      
      // Scroll to results
      document.getElementById('analysis-results').scrollIntoView({ behavior: 'smooth' });
    }
    
    function addToRecentAnalyses(data) {
      const recentAnalyses = document.getElementById('recent-analyses');
      const locationName = document.getElementById('location-search').value || `${currentLat.toFixed(4)}, ${currentLng.toFixed(4)}`;
      const now = new Date().toLocaleString();
      
      const analysisItem = document.createElement('a');
      analysisItem.href = '#';
      analysisItem.className = 'list-group-item list-group-item-action';
      analysisItem.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1">${locationName}</h6>
          <small>${now}</small>
        </div>
        <p class="mb-1">${data.analysis.substring(0, 60)}...</p>
      `;
      
      // Add click handler to reload this analysis
      analysisItem.addEventListener('click', function(e) {
        e.preventDefault();
        displayAnalysisResults(data);
      });
      
      // Add to the top of the list
      if (recentAnalyses.firstChild) {
        recentAnalyses.insertBefore(analysisItem, recentAnalyses.firstChild);
      } else {
        recentAnalyses.appendChild(analysisItem);
      }
      
      // Limit to 5 recent analyses
      if (recentAnalyses.children.length > 5) {
        recentAnalyses.removeChild(recentAnalyses.lastChild);
      }
    }
    
    function showError(message) {
      document.getElementById('error-message').textContent = message;
      const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
      errorModal.show();
    }
    
    // Initialize the app when the DOM is loaded
    // Initialize voice recognition if available
    function initVoiceRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const voiceBtn = document.getElementById('voice-search-btn');
      const voiceStatus = document.getElementById('voice-status');
      
      if (!SpeechRecognition) {
        // Hide voice button if not supported
        voiceBtn.style.display = 'none';
        return;
      }
      
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('location-search').value = transcript;
        updateLocationSearch();
      };
      
      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        let errorMessage = 'Voice recognition error: ';
        
        switch(event.error) {
          case 'not-allowed':
            errorMessage = 'Microphone access was denied. Please allow microphone access in your browser settings.';
            voiceBtn.innerHTML = '<i class="bi bi-mic-mute"></i>';
            voiceBtn.title = 'Microphone access denied';
            break;
          case 'audio-capture':
            errorMessage = 'No microphone was found. Please ensure a microphone is connected.';
            break;
          case 'not-supported':
            errorMessage = 'Your browser does not support speech recognition. Try using Chrome or Edge.';
            voiceBtn.style.display = 'none';
            return;
          default:
            errorMessage += event.error;
        }
        
        showError(errorMessage);
        voiceStatus.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning"></i> ' + errorMessage;
      };
      
      recognition.onend = function() {
        isListening = false;
        voiceStatus.style.display = 'none';
        voiceBtn.classList.remove('pulse', 'btn-danger');
        voiceBtn.innerHTML = '<i class="bi bi-mic"></i>';
        voiceBtn.title = 'Search by voice';
      };
      
      // Add click handler for voice search button
      voiceBtn.addEventListener('click', async function() {
        if (isListening) {
          recognition.stop();
          return;
        }
        
        try {
          // Request microphone permission first
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          // Stop the stream immediately since we only needed to check permission
          stream.getTracks().forEach(track => track.stop());
          
          // If we got here, permission was granted
          recognition.start();
          isListening = true;
          voiceStatus.style.display = 'block';
          voiceStatus.innerHTML = '<i class="bi bi-mic-fill text-danger"></i> Listening...';
          this.classList.add('pulse', 'btn-danger');
          this.innerHTML = '<i class="bi bi-mic-mute"></i>';
          this.title = 'Click to stop listening';
        } catch (error) {
          console.error('Error accessing microphone:', error);
          let errorMessage = 'Error accessing microphone: ';
          
          if (error.name === 'NotAllowedError') {
            errorMessage = 'Microphone access was denied. Please allow microphone access in your browser settings and try again.';
            voiceBtn.innerHTML = '<i class="bi bi-mic-mute"></i>';
            voiceBtn.title = 'Microphone access denied';
          } else if (error.name === 'NotFoundError') {
            errorMessage = 'No microphone found. Please ensure a microphone is connected.';
          } else if (error.name === 'NotReadableError') {
            errorMessage = 'Could not access the microphone. Another application might be using it.';
          }
          
          showError(errorMessage);
          voiceStatus.style.display = 'block';
          voiceStatus.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning"></i> ' + errorMessage;
        }
      });
      
      // Add permission state change handler
      if (navigator.permissions) {
        navigator.permissions.query({name: 'microphone'}).then(function(permissionStatus) {
          permissionStatus.onchange = function() {
            if (this.state === 'granted') {
              voiceBtn.innerHTML = '<i class="bi bi-mic"></i>';
              voiceBtn.title = 'Search by voice';
              voiceStatus.style.display = 'none';
            } else if (this.state === 'denied') {
              voiceBtn.innerHTML = '<i class="bi bi-mic-mute"></i>';
              voiceBtn.title = 'Microphone access denied';
              voiceStatus.style.display = 'block';
              voiceStatus.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning"></i> Microphone access denied. Please check your browser settings.';
            }
          };
        });
      }
    }
    
    // Read text aloud using Gemma TTS
    async function readAloud(text) {
      const button = document.getElementById('read-aloud-btn');
      
      try {
        // Update button state
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        
        // Call our backend TTS endpoint
        const response = await fetch('/api/tts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ text: text })
        });
        
        if (!response.ok) {
          throw new Error('Failed to process TTS request');
        }
        
        const data = await response.json();
        
        // Fallback to browser's built-in TTS if available
        if (window.speechSynthesis) {
          const synthesis = window.speechSynthesis;
          synthesis.cancel();
          
          const utterance = new SpeechSynthesisUtterance(text);
          const voices = synthesis.getVoices();
          const preferredVoices = voices.filter(voice => voice.lang.startsWith('en'));
          
          if (preferredVoices.length > 0) {
            const naturalVoice = preferredVoices.find(v => v.name.includes('Natural')) || 
                                preferredVoices[0];
            utterance.voice = naturalVoice;
          }
          
          utterance.rate = 1.0;
          utterance.pitch = 1.0;
          utterance.volume = 1.0;
          
          utterance.onend = function() {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-volume-up"></i>';
          };
          
          synthesis.speak(utterance);
        } else {
          // Fallback to simple alert if no TTS available
          button.disabled = false;
          button.innerHTML = '<i class="bi bi-volume-up"></i>';
          alert('Text-to-speech is not supported in your browser. Here\'s the text to read:\n\n' + text);
        }
      } catch (error) {
        console.error('TTS Error:', error);
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-volume-up"></i>';
        showError('Failed to process text-to-speech. Please try again.');
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      initMap();
      updateLocationSearch();
      initVoiceRecognition();
      
      // Add click handler for read aloud button
      document.getElementById('read-aloud-btn').addEventListener('click', function() {
        const analysisText = document.getElementById('detailed-analysis').innerText;
        if (analysisText && analysisText !== 'Detailed analysis will appear here after running an analysis.') {
          readAloud(analysisText);
        }
      });
    });
  </script>
</body>
</html>
